notifications:
  email: false
language: c #NOTE: this will set CC=gcc which might cause trouble
before_script:
  - "sudo apt-get -qq update"

  ## Install uncrustify and jq for code-style tests
  - "[ ${BUILD_CATEGORY:-sim} = code-style ] && sudo apt-get -qq install uncrustify jq || true"

  ## Install toolchain for mc1233x, cc2538 and mbxxx in care-free way
  - "[ ${BUILD_ARCH:-0} = arm ] && curl -s \
       https://raw.githubusercontent.com/wiki/malvira/libmc1322x/files/arm-2008q3-66-arm-none-eabi-i686-pc-linux-gnu.tar.bz2 \
         | tar xjf - -C /tmp/ && sudo cp -f -r /tmp/arm-2008q3/* /usr/ && rm -rf /tmp/arm-2008q3 && arm-none-eabi-gcc --version || true"

  ## Install SDCC from a purpose-built bundle
  - "[ ${BUILD_ARCH:-0} = 8051 ] && curl -s \
       https://raw.githubusercontent.com/wiki/g-oikonomou/contiki-sensinode/files/sdcc.tar.gz \
         | tar xzf - -C /tmp/ && sudo cp -f -r /tmp/sdcc/* /usr/local/ && rm -rf /tmp/sdcc && sdcc --version || true"
  - "[ ${BUILD_ARCH:-0} = 8051 ] && sudo apt-get -qq install srecord || true"

  ## Clone and build cc65 when testing 6502 ports
  - "[ ${BUILD_ARCH:-0} = 6502 ] && git clone \
       https://github.com/cc65/cc65 /tmp/cc65 && \
       make -C /tmp/cc65 bin apple2enh atarixl c64 c128 && sudo make -C /tmp/cc65 avail && \
       export CC65_HOME=/tmp/cc65/ && cc65 --version || true"

  ## Compile cooja.jar only when it's going to be needed
  - "[ ${BUILD_CATEGORY:-sim} = sim ] && java -version && ant -q -f tools/cooja/build.xml jar && sudo java -Xshare:dump -version || true"

  ## IMPORTANT: The commands here have to end with `|| true`,
  ## because it would make the test fail if BUILD_TYPE test fails

script:
  ## regression-tests/Makefile handles most of generic logic
  - "make -C regression-tests/??-$BUILD_TYPE RUNALL=true summary"

after_script:
  ## Print cooja test logs
  - "[ ${BUILD_CATEGORY:-sim} = sim ] && tail regression-tests/??-$BUILD_TYPE/*.testlog"
  ## Print a basic summary 
  - "echo 'Summary:'; cat regression-tests/??-$BUILD_TYPE/summary"
  - "FAILS=`grep -c -i 'fail' regression-tests/??-$BUILD_TYPE/summary`"
  ## This will detect whether the build should pass or fail
  - "test $FAILS -eq 0; exit $?"


env:
  ## This magically kick-off parallel jobs for each of the for the sets
  ## of environment variable defined below
  - BUILD_TYPE='code-style' BUILD_CATEGORY='code-style'
